{% extends 'base.html' %}

{% block title %}Детали заявки - Платформа психолога{% endblock %}

{% block content %}
<section class="feedback-form-section application-detail-section">
    <div class="section-content application-detail-content">
        <div class="back-button-container">
            {% if user.is_admin_user %}
                <a href="{% url 'dashboard_admin' %}" class="btn btn-secondary">← Назад к панели управления</a>
            {% else %}
                <a href="{% url 'dashboard_psychologist' %}" class="btn btn-secondary">← Назад к списку заявок</a>
            {% endif %}
        </div>
        
        <h2>Детали заявки</h2>
        
        <div class="application-info-box">
            <div class="application-info-item">
                <strong>Тема:</strong> {{ application.title }}
            </div>
            <div class="application-info-item">
                <strong>Студент:</strong> {{ application.user.get_display_name }}
            </div>
            <div class="application-info-item">
                <strong>Email студента:</strong> {{ application.user.email }}
            </div>
            <div class="application-info-item">
                <strong>Статус:</strong>
                <span class="application-status status-{{ application.status }}">
                    {{ application.get_status_display }}
                </span>
            </div>
            <div class="application-info-item">
                <strong>Психолог:</strong>
                {% if application.psychologist %}
                    {{ application.psychologist.get_display_name }}
                {% else %}
                    Не назначен
                {% endif %}
            </div>
            <div class="application-info-item">
                <strong>Дата создания:</strong> {{ application.created_at|date:"d.m.Y H:i" }}
            </div>
            {% if application.updated_at != application.created_at %}
                <div class="application-info-item">
                    <strong>Дата обновления:</strong> {{ application.updated_at|date:"d.m.Y H:i" }}
                </div>
            {% endif %}
        </div>
        
        <div class="application-description-box">
            <h3>Описание проблемы</h3>
            <div class="application-description-content">
                <p class="application-description-text">{{ application.description }}</p>
            </div>
        </div>
        
        {% if not application.psychologist %}
            <div class="take-application-section">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="take_application" value="1">
                    <button type="submit" class="btn btn-primary">Взять заявку в работу</button>
                </form>
            </div>
        {% elif application.psychologist == user and application.status != "completed" %}
            {% if not existing_report %}
                <div class="report-section">
                    <h3>Завершить работу над заявкой</h3>
                    <p>Для завершения работы над заявкой необходимо заполнить отчет о проделанной работе.</p>
                    <form method="post" class="report-form">
                        {% csrf_token %}
                        <input type="hidden" name="complete_application" value="1">
                        {% if report_form.non_field_errors %}
                            <div class="form-error" style="margin-bottom: 1rem; padding: 1rem; background-color: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33;">
                                {% for error in report_form.non_field_errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-group">
                            <label for="{{ report_form.report_text.id_for_label }}">
                                {{ report_form.report_text.label }}
                            </label>
                            {{ report_form.report_text }}
                            {% if report_form.report_text.errors %}
                                <div class="form-error">{{ report_form.report_text.errors }}</div>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn btn-success btn-submit-margin">Завершить работу и сохранить отчет</button>
                    </form>
                </div>
            {% endif %}
        {% endif %}
        
        {% if existing_report %}
            <div class="report-display-section">
                <h3>Отчет о работе</h3>
                <div class="report-info-box">
                    <div class="application-info-item">
                        <strong>Дата создания отчета:</strong> {{ existing_report.created_at|date:"d.m.Y H:i" }}
                    </div>
                </div>
                <div class="report-text-box">
                    <p class="report-text">{{ existing_report.report_text|linebreaks }}</p>
                </div>
            </div>
        {% endif %}
        
        {% if application.psychologist == user or not application.psychologist %}
            {% if application.status != "completed" %}
                <div class="consultation-form-section">
                    <h3>Ответить на заявку</h3>
                    <form method="post" class="consultation-form">
                        {% csrf_token %}
                        <input type="hidden" name="add_consultation" value="1">
                        <div class="form-group">
                            <label for="{{ consultation_form.message.id_for_label }}">
                                {{ consultation_form.message.label }}
                            </label>
                            {{ consultation_form.message }}
                            {% if consultation_form.message.errors %}
                                <div class="form-error">{{ consultation_form.message.errors }}</div>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn btn-primary btn-submit-margin">Отправить ответ</button>
                    </form>
                </div>
                
                <div class="meeting-section">
                    <h3>Назначить встречу</h3>
                    <form method="post" class="meeting-form">
                        {% csrf_token %}
                        <input type="hidden" name="add_meeting" value="1">
                        {% if meeting_form.non_field_errors %}
                            <div class="form-error" style="margin-bottom: 1rem; padding: 1rem; background-color: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33;">
                                {% for error in meeting_form.non_field_errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-group">
                            <label for="{{ meeting_form.date.id_for_label }}">
                                {{ meeting_form.date.label }}
                            </label>
                            {{ meeting_form.date }}
                            {% if meeting_form.date.errors %}
                                <div class="form-error">{{ meeting_form.date.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ meeting_form.time.id_for_label }}">
                                {{ meeting_form.time.label }}
                            </label>
                            {{ meeting_form.time }}
                            {% if meeting_form.time.errors %}
                                <div class="form-error">{{ meeting_form.time.errors }}</div>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn btn-primary btn-submit-margin">Назначить встречу</button>
                    </form>
                </div>
            {% endif %}
        {% endif %}
        
        {% if consultations %}
            <div class="consultations-section">
                <h3>История сообщений</h3>
                {% for consultation in consultations %}
                    <div class="consultation-card {% if consultation.is_from_psychologist %}consultation-from-psychologist{% else %}consultation-from-student{% endif %}">
                        <div class="consultation-card-header">
                            <strong>
                                {% if consultation.is_from_psychologist %}
                                    {{ consultation.psychologist.get_display_name }} (Вы)
                                {% else %}
                                    {{ consultation.student.get_display_name }} (Студент)
                                {% endif %}
                            </strong>
                            <span class="consultation-date">
                                {{ consultation.created_at|date:"d.m.Y H:i" }}
                            </span>
                        </div>
                        <p class="consultation-card-message">{{ consultation.message }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</section>
{% endblock %}

